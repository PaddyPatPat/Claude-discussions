#+TITLE: Troubleshooting Linux DNS Configuration
#+AUTHOR: Claude
#+DATE: [2025-11-09]
#+TAGS: linux dns troubleshooting debugging networking systemd

* Overview

Diagnosing DNS issues on Linux requires understanding which system is currently managing DNS configuration and whether it's working correctly. This guide provides systematic diagnostic procedures, explains how to interpret results, and offers solutions for common problems.

Use this guide when:
- DNS resolution isn't working
- You're getting warnings about DNS configuration
- Multiple services seem to be fighting over /etc/resolv.conf
- You need to understand your current DNS setup
- Tailscale or other VPN services report DNS issues

* Quick Diagnostic Checklist

Run these commands to get a complete picture of your DNS configuration:

#+BEGIN_SRC bash
# 1. Check if NetworkManager is running
systemctl status NetworkManager

# 2. Check what /etc/resolv.conf is (symlink or regular file?)
ls -la /etc/resolv.conf

# 3. Check if systemd-resolved is managing DNS
systemctl status systemd-resolved

# 4. See what's listening on port 53 (DNS)
sudo ss -tlnp | grep :53

# 5. Check if resolvconf package is installed
dpkg -l | grep resolvconf

# 6. Check systemd-networkd status
systemctl status systemd-networkd
# or
networkctl status
#+END_SRC

* Understanding /etc/resolv.conf

** Checking the File Type

#+BEGIN_SRC bash
ls -la /etc/resolv.conf
#+END_SRC

*** Possible Results

**** Regular File
#+BEGIN_SRC text
-rw-r--r-- 1 root root 63 Nov 9 10:00 /etc/resolv.conf
#+END_SRC

This is a regular file, which means:
- It's static (unless something actively updates it)
- Check the contents to see who generated it
- May have been written by NetworkManager, dhclient, or manually

**** Symlink to systemd-resolved stub
#+BEGIN_SRC text
lrwxrwxrwx 1 root root 39 Nov 9 10:00 /etc/resolv.conf -> /run/systemd/resolve/stub-resolv.conf
#+END_SRC

This means:
- systemd-resolved is managing DNS
- Local DNS cache is active at 127.0.0.53
- Applications query the local resolver
- systemd-resolved forwards to actual nameservers

**** Symlink to systemd-resolved direct
#+BEGIN_SRC text
lrwxrwxrwx 1 root root 37 Nov 9 10:00 /etc/resolv.conf -> /run/systemd/resolve/resolv.conf
#+END_SRC

This means:
- systemd-resolved is managing DNS
- No local caching (applications go directly to upstream nameservers)
- Less common configuration

**** Symlink to resolvconf
#+BEGIN_SRC text
lrwxrwxrwx 1 root root 29 Nov 9 10:00 /etc/resolv.conf -> ../run/resolvconf/resolv.conf
#+END_SRC

This means:
- resolvconf framework is managing DNS
- Multiple programs can contribute to DNS configuration
- Common on traditional Debian/Ubuntu systems

** Reading the File Contents

#+BEGIN_SRC bash
cat /etc/resolv.conf
#+END_SRC

Look for:
- Comment lines indicating which program generated it
- Nameserver entries (=nameserver 8.8.8.8=)
- Search domains (=search example.com=)
- Options (=options timeout:2=)

*** Example: NetworkManager Generated
#+BEGIN_SRC text
# Generated by NetworkManager
nameserver 192.168.1.1
search local.domain
#+END_SRC

*** Example: systemd-resolved Stub
#+BEGIN_SRC text
# This file is managed by man:systemd-resolved(8).
nameserver 127.0.0.53
options edns0 trust-ad
search .
#+END_SRC

*** Example: Static Manual Configuration
#+BEGIN_SRC text
nameserver 8.8.8.8
nameserver 8.8.4.4
nameserver 2001:4860:4860::8888
#+END_SRC

* Checking Active Services

** NetworkManager

#+BEGIN_SRC bash
systemctl status NetworkManager
#+END_SRC

*** Running
#+BEGIN_SRC text
● NetworkManager.service - Network Manager
   Loaded: loaded (/lib/systemd/system/NetworkManager.service; enabled)
   Active: active (running) since ...
#+END_SRC

NetworkManager is actively managing your network and likely your DNS.

*** Not Running
#+BEGIN_SRC text
● NetworkManager.service - Network Manager
   Loaded: loaded (/lib/systemd/system/NetworkManager.service; disabled)
   Active: inactive (dead)
#+END_SRC

NetworkManager is installed but not managing your system.

** systemd-resolved

#+BEGIN_SRC bash
systemctl status systemd-resolved
#+END_SRC

*** Active with Full Status
#+BEGIN_SRC bash
# Get detailed DNS information
resolvectl status
#+END_SRC

This shows:
- Which DNS servers are configured
- Per-interface DNS settings
- DNSSEC status
- DNS-over-TLS status

Example output:
#+BEGIN_SRC text
Global
       LLMNR setting: yes
MulticastDNS setting: yes
  DNSOverTLS setting: no
      DNSSEC setting: allow-downgrade
    DNSSEC supported: yes
  Current DNS Server: 192.168.1.1
         DNS Servers: 192.168.1.1
                      8.8.8.8

Link 2 (eth0)
      Current Scopes: DNS LLMNR/IPv4 LLMNR/IPv6
       LLMNR setting: yes
MulticastDNS setting: no
      DNSSEC setting: allow-downgrade
    DNSSEC supported: yes
  Current DNS Server: 192.168.1.1
         DNS Servers: 192.168.1.1
#+END_SRC

** systemd-networkd

#+BEGIN_SRC bash
systemctl status systemd-networkd
#+END_SRC

Or use the networkctl command:

#+BEGIN_SRC bash
networkctl status
#+END_SRC

*** Important Note

systemd-networkd and systemd-resolved are **separate services**:
- networkd manages network interfaces, IP addresses, routing
- resolved manages DNS resolution
- They can run independently
- "networkd not running" doesn't mean resolved isn't working

** resolvconf Framework

#+BEGIN_SRC bash
# Check if installed
dpkg -l | grep resolvconf

# Check if it's a package or part of systemd
dpkg -L resolvconf | head -20
#+END_SRC

*** Traditional resolvconf Package
Will show files in /sbin/resolvconf, /etc/resolvconf/

*** systemd's resolvconf Compatibility
May be a symlink to systemd-resolved's implementation

* Checking DNS Service Listeners

See what's actually listening on the DNS port (53):

#+BEGIN_SRC bash
sudo ss -tlnp | grep :53
#+END_SRC

Or using netstat:

#+BEGIN_SRC bash
sudo netstat -tlnp | grep :53
#+END_SRC

** Common Results

*** systemd-resolved Local Cache
#+BEGIN_SRC text
LISTEN 0 4096 127.0.0.53:53 0.0.0.0:* users:(("systemd-resolved",pid=1234,fd=12))
#+END_SRC

Local DNS cache on 127.0.0.53 (systemd-resolved stub resolver)

*** dnsmasq Local Cache
#+BEGIN_SRC text
LISTEN 0 5 127.0.0.1:53 0.0.0.0:* users:(("dnsmasq",pid=5678,fd=5))
#+END_SRC

dnsmasq providing local DNS caching (sometimes used by NetworkManager)

*** No Local DNS Service
#+BEGIN_SRC text
(no output)
#+END_SRC

No local DNS cache; queries go directly to nameservers in /etc/resolv.conf

*** Unbound or BIND
#+BEGIN_SRC text
LISTEN 0 5 127.0.0.1:53 0.0.0.0:* users:(("unbound",pid=9012,fd=6))
#+END_SRC

A local recursive DNS resolver is running

* Testing DNS Resolution

** Basic DNS Lookup

#+BEGIN_SRC bash
# Using getent (uses system resolver configuration)
getent hosts google.com

# Using host
host google.com

# Using nslookup (interactive)
nslookup google.com

# Using dig (detailed)
dig google.com

# Test specific nameserver
dig @8.8.8.8 google.com
#+END_SRC

** systemd-resolved Specific Testing

#+BEGIN_SRC bash
# Query through systemd-resolved
resolvectl query google.com

# Detailed query with metadata
resolvectl query google.com --type=A --class=IN

# Statistics
resolvectl statistics
#+END_SRC

** Testing DNSSEC

#+BEGIN_SRC bash
# Check if DNSSEC validation is working
dig example.com +dnssec

# Or with resolvectl
resolvectl query example.com --type=A
# Look for "authenticated: yes" in output
#+END_SRC

* Common Scenarios and Solutions

** Scenario 1: "Generated by NetworkManager" but NetworkManager Not Running

*** Diagnosis
#+BEGIN_SRC bash
# NetworkManager is not running
systemctl status NetworkManager
# Shows: inactive (dead)

# But /etc/resolv.conf says "Generated by NetworkManager"
cat /etc/resolv.conf
#+END_SRC

*** What Happened
NetworkManager wrote the file in the past, then was stopped/disabled. The file remains as a static configuration.

*** Solutions

**** Option 1: Re-enable NetworkManager
#+BEGIN_SRC bash
sudo systemctl enable NetworkManager
sudo systemctl start NetworkManager
#+END_SRC

**** Option 2: Switch to systemd-resolved
#+BEGIN_SRC bash
# Enable and start systemd-resolved
sudo systemctl enable systemd-resolved
sudo systemctl start systemd-resolved

# Create symlink
sudo ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf
#+END_SRC

**** Option 3: Keep Static Configuration
If DNS is working and you don't need dynamic updates, you can leave it as-is. Just ensure the nameservers are correct.

** Scenario 2: Multiple Services Fighting Over /etc/resolv.conf

*** Symptoms
- /etc/resolv.conf keeps changing
- DNS works intermittently
- Warnings from Tailscale or other services

*** Diagnosis
#+BEGIN_SRC bash
# Monitor the file for changes
watch -n 1 cat /etc/resolv.conf

# Check what's running
systemctl status NetworkManager systemd-resolved

# Check for DHCP client
ps aux | grep dhclient
#+END_SRC

*** Solution
Choose one DNS manager and disable the others:

**** Keep NetworkManager
#+BEGIN_SRC bash
# Disable systemd-resolved DNS management
sudo systemctl disable systemd-resolved
sudo systemctl stop systemd-resolved
#+END_SRC

**** Keep systemd-resolved
#+BEGIN_SRC bash
# Configure NetworkManager to use systemd-resolved
# Edit /etc/NetworkManager/NetworkManager.conf
[main]
dns=systemd-resolved

sudo systemctl restart NetworkManager
#+END_SRC

** Scenario 3: Tailscale "DNS config is not ideal" Warning

See [[file:tailscale-dns-configuration.org][Tailscale DNS Configuration]] for complete details.

*** Quick Fix
#+BEGIN_SRC bash
# Tell Tailscale to manage DNS
sudo tailscale up --accept-dns

# If that doesn't work, check what's overriding it
ls -la /etc/resolv.conf
systemctl status NetworkManager systemd-resolved
#+END_SRC

** Scenario 4: DNS Works But Very Slow

*** Diagnosis
#+BEGIN_SRC bash
# Time DNS queries
time dig google.com

# Check if IPv6 is causing timeouts
dig google.com AAAA

# Check if a local cache exists
sudo ss -tlnp | grep :53
#+END_SRC

*** Common Causes
1. No local DNS cache (every query goes to remote nameserver)
2. IPv6 DNS servers timing out
3. DNSSEC validation failures
4. Overloaded or distant nameservers

*** Solutions

**** Enable Local DNS Caching
Use systemd-resolved:
#+BEGIN_SRC bash
sudo systemctl enable systemd-resolved
sudo systemctl start systemd-resolved
sudo ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf
#+END_SRC

Or install dnsmasq:
#+BEGIN_SRC bash
sudo apt install dnsmasq
sudo systemctl enable dnsmasq
sudo systemctl start dnsmasq
#+END_SRC

**** Disable IPv6 DNS if Broken
Edit /etc/resolv.conf and remove IPv6 nameserver entries (starting with =2001:=, =2606:=, etc.)

**** Use Faster Nameservers
#+BEGIN_SRC text
nameserver 1.1.1.1       # Cloudflare
nameserver 8.8.8.8       # Google
nameserver 9.9.9.9       # Quad9
#+END_SRC

* Advanced Diagnostics

** Tracing DNS Queries

*** Using tcpdump
#+BEGIN_SRC bash
# Capture DNS queries and responses
sudo tcpdump -i any -n port 53

# More readable output
sudo tcpdump -i any -n port 53 -A
#+END_SRC

*** Using systemd-resolved Debug Logging
#+BEGIN_SRC bash
# Enable debug logging
sudo systemctl edit systemd-resolved
# Add:
[Service]
Environment=SYSTEMD_LOG_LEVEL=debug

sudo systemctl restart systemd-resolved

# View logs
sudo journalctl -u systemd-resolved -f
#+END_SRC

** Checking DHCP DNS Assignment

#+BEGIN_SRC bash
# Check DHCP lease file
cat /var/lib/dhcp/dhclient.leases

# Or for NetworkManager
cat /var/lib/NetworkManager/*.lease

# For systemd-networkd
networkctl status <interface>
#+END_SRC

** Verifying DNS Propagation

#+BEGIN_SRC bash
# Query multiple nameservers
for ns in 8.8.8.8 1.1.1.1 9.9.9.9; do
  echo "Nameserver: $ns"
  dig @$ns example.com +short
done
#+END_SRC

* Preventive Monitoring

** Create a DNS Health Check Script

#+BEGIN_SRC bash
#!/bin/bash
# dns-health-check.sh

echo "=== DNS Health Check ==="
echo ""

echo "1. /etc/resolv.conf type:"
ls -la /etc/resolv.conf
echo ""

echo "2. /etc/resolv.conf contents:"
cat /etc/resolv.conf
echo ""

echo "3. Active DNS services:"
systemctl status NetworkManager systemd-resolved --no-pager | grep Active
echo ""

echo "4. DNS listeners:"
sudo ss -tlnp | grep :53
echo ""

echo "5. DNS resolution test:"
time dig google.com +short
echo ""

echo "6. Tailscale status (if installed):"
command -v tailscale >/dev/null && tailscale status --json | jq .Health
#+END_SRC

** Regular Monitoring

#+BEGIN_SRC bash
# Add to cron for daily checks
0 9 * * * /path/to/dns-health-check.sh > /var/log/dns-health.log 2>&1
#+END_SRC

* Related Topics

- [[file:linux-dns-management-systems.org][Linux DNS Management Systems]] - Understanding DNS management tools
- [[file:tailscale-dns-configuration.org][Tailscale DNS Configuration]] - Tailscale-specific DNS setup

* References

- systemd-resolved: =man systemd-resolved=, =man resolvectl=
- NetworkManager: =man NetworkManager=, =man nmcli=
- DNS testing: =man dig=, =man host=, =man nslookup=
- resolvconf: =man resolvconf=

* TODO Tasks

- TODO Document DNS behavior during network transitions (WiFi to Ethernet)
- TODO Create automated DNS problem detection script
- TODO Test DNS behavior with multiple active VPN connections
- TODO Document DNS-over-HTTPS and DNS-over-TLS troubleshooting
