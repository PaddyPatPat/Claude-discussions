#+TITLE: Linux DNS Management Systems
#+AUTHOR: Claude
#+DATE: [2025-11-09]
#+TAGS: linux dns networking systemd debian

* Overview

Linux systems can have multiple DNS management systems installed and potentially active simultaneously. This creates confusion because /etc/resolv.conf can be managed by different services at different times, and the file itself may contain comments indicating which tool "generated" it, even if that tool is no longer active.

This document explains the major DNS management systems on Linux, how they interact, and how to identify which one is currently controlling your system's DNS configuration.

* The /etc/resolv.conf Mystery

** Historical Context

The /etc/resolv.conf file is the traditional Unix/Linux configuration file that specifies DNS nameservers. Originally, this was a simple static text file that administrators edited manually. Modern Linux distributions have introduced multiple automated systems to manage this file dynamically.

** Common Source of Confusion

A file can show it was "generated by NetworkManager" (or another tool) even when:
- That tool is no longer running
- That tool has been disabled or removed
- A different tool is now managing DNS
- The file was written once and left static

The comment in the file indicates who wrote it last, not who is currently managing it.

* Major DNS Management Systems

** NetworkManager

NetworkManager is a comprehensive network management daemon commonly used on desktop Linux distributions.

*** Features
- Dynamic network configuration
- WiFi and Ethernet management
- VPN integration
- Automatic DNS configuration from DHCP

*** DNS Management Behavior
- Writes directly to /etc/resolv.conf by default
- Can be configured to use other DNS management backends
- Leaves generated file in place if stopped

*** Check if Active
#+BEGIN_SRC bash
systemctl status NetworkManager
#+END_SRC

** systemd-resolved

A modern DNS resolution service that's part of the systemd ecosystem, offering advanced features like DNS caching, DNSSEC validation, and DNS-over-TLS.

*** Features
- Local DNS caching (listens on 127.0.0.53)
- DNSSEC validation
- DNS-over-TLS support
- Link-specific DNS configuration
- Integration with systemd-networkd

*** DNS Management Behavior
- Creates /etc/resolv.conf as a symlink to one of:
  - /run/systemd/resolve/stub-resolv.conf (points to local cache at 127.0.0.53)
  - /run/systemd/resolve/resolv.conf (direct upstream nameservers)
- Applications query the local caching resolver
- Provides API for other services to configure DNS

*** Check if Active
#+BEGIN_SRC bash
systemctl status systemd-resolved
#+END_SRC

*** Check if /etc/resolv.conf is Managed by systemd-resolved
#+BEGIN_SRC bash
ls -la /etc/resolv.conf
# Look for symlink to /run/systemd/resolve/
#+END_SRC

** systemd-networkd

A network configuration daemon that's separate from systemd-resolved, though they often work together.

*** Important Distinction
- systemd-networkd: Manages network interfaces and routing
- systemd-resolved: Manages DNS resolution
- They are separate services that complement each other
- networkd can be inactive while resolved is active, and vice versa

*** Features
- Network interface configuration
- Static IP and DHCP support
- Routing and bridging
- Works with systemd-resolved for DNS

*** Check if Active
#+BEGIN_SRC bash
systemctl status systemd-networkd
# or
networkctl status
#+END_SRC

** resolvconf Package

The traditional Debian/Ubuntu framework for managing /etc/resolv.conf dynamically.

*** Features
- Provides a standardized interface for programs to update DNS
- Multiple programs can contribute nameservers
- Prioritizes and merges DNS information from different sources

*** Behavior
- DHCP clients, VPN clients, and network managers write to resolvconf
- resolvconf assembles the final /etc/resolv.conf

*** Check if Installed
#+BEGIN_SRC bash
dpkg -l | grep resolvconf
#+END_SRC

** dhclient

The ISC DHCP client, which can directly manage /etc/resolv.conf if no other system intercepts it.

*** Behavior
- Receives DNS servers from DHCP server
- Can write directly to /etc/resolv.conf
- Usually integrated with NetworkManager or resolvconf on modern systems

*** Configuration
- Main config: /etc/dhcp/dhclient.conf
- Hook scripts: /etc/dhcp/dhclient-enter-hooks.d/, /etc/dhcp/dhclient-exit-hooks.d/

* Coexistence and Priority

** Multiple Systems Can Be Installed

It's normal to have several DNS management systems installed simultaneously. The key question is which one is actually active and managing /etc/resolv.conf.

** Common Scenarios by Distribution

*** Debian
- Traditional: NetworkManager or resolvconf + dhclient
- Modern: systemd-resolved + systemd-networkd

*** Ubuntu Desktop
- Typically: NetworkManager with systemd-resolved as backend

*** Ubuntu Server
- Typically: systemd-networkd + systemd-resolved
- Or: netplan with systemd-resolved backend

** Determining Active System

See [[file:troubleshooting-linux-dns.org][Troubleshooting Linux DNS]] for complete diagnostic procedures.

* Integration with Network Services

** Tailscale Considerations

When running Tailscale (especially as an exit node), DNS configuration becomes critical for proper routing behavior. See [[file:tailscale-dns-configuration.org][Tailscale DNS Configuration]] for details on:
- MagicDNS integration
- Exit node DNS routing
- Common Tailscale DNS warnings

** VPN Services

VPN clients often need to:
- Temporarily override DNS settings
- Split DNS (some domains use VPN DNS, others use default)
- Restore DNS when disconnecting

They typically integrate with:
- NetworkManager (via plugins)
- systemd-resolved (via D-Bus API)
- resolvconf (via command-line tools)

* Best Practices

** For Servers
- Use systemd-resolved + systemd-networkd for modern, consistent configuration
- Or use static /etc/resolv.conf if DNS rarely changes
- Document which system is in use

** For Desktops
- NetworkManager is often the most user-friendly
- Can use systemd-resolved as NetworkManager backend for caching benefits

** For Tailscale Exit Nodes
- Ensure DNS system can accept dynamic updates from Tailscale
- Use =--accept-dns= flag appropriately
- Monitor for DNS configuration conflicts

* Related Topics

- [[file:troubleshooting-linux-dns.org][Troubleshooting Linux DNS]] - Diagnostic commands and procedures
- [[file:tailscale-dns-configuration.org][Tailscale DNS Configuration]] - Tailscale-specific DNS setup

* References

- systemd-resolved documentation: =man systemd-resolved=
- NetworkManager documentation: =man NetworkManager=
- Debian Network Configuration: https://wiki.debian.org/NetworkConfiguration

* TODO Tasks

- TODO Research DNS-over-HTTPS configuration with systemd-resolved
- TODO Document netplan integration with DNS systems
- TODO Test DNS failover scenarios with multiple nameservers
